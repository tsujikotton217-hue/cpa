<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPAç©¶æ¥µç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - AIå…¨è§£æç‰ˆ</title>
    <style>
        :root { --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --accent: #2563eb; --border: #e2e8f0; --review: #f1f5f9; --success: #10b981; --danger: #ef4444; --plan: #8b5cf6; }
        .dark-mode { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --accent: #3b82f6; --border: #334155; --review: #334155; }
        
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; transition: 0.3s; display: flex; flex-direction: column; align-items: center; }
        .container { display: grid; grid-template-columns: 360px 1fr; gap: 20px; max-width: 1200px; width: 100%; }
        
        @media (max-width: 850px) {
            .container { grid-template-columns: 1fr; }
            .timer-display { font-size: 3.5rem !important; }
            .top-bar { flex-direction: column; gap: 10px; text-align: center; }
        }

        .card { background: var(--card); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        
        .timer-display { font-size: 4.5rem; font-weight: 800; text-align: center; font-variant-numeric: tabular-nums; margin: 5px 0; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-main { padding: 15px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1rem; }
        #start-btn { background: #0f172a; color: white; grid-column: span 2; }
        .dark-mode #start-btn { background: #3b82f6; }
        #stop-btn { background: #e2e8f0; color: #1e293b; }
        #cancel-btn { background: #fee2e2; color: var(--danger); }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 1200px; margin-bottom: 20px; padding: 0 10px; }
        .backup-btn { font-size: 0.75rem; padding: 6px 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); cursor: pointer; border-radius: 4px; margin-left: 5px; }
        
        .sync-btn { background: #fef3c7; border-color: #f59e0b; color: #92400e; font-weight: bold; }
        .dark-mode .sync-btn { background: #78350f; border-color: #f59e0b; color: #fef3c7; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); }
        .cal-header { background: #e2e8f0; font-size: 0.7rem; text-align: center; font-weight: bold; padding: 5px 0; color: #475569; }
        .dark-mode .cal-header { background: #334155; color: #94a3b8; }
        .cal-day { background: var(--card); min-height: 60px; padding: 5px; cursor: pointer; position: relative; font-size: 0.75rem; }
        .cal-day.active { background: var(--accent) !important; color: white !important; }
        .marker-container { position: absolute; bottom: 3px; right: 3px; display: flex; gap: 1px; }
        .dot { font-size: 8px; }

        .chart-box { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; }
        .pie-chart { width: 150px; height: 150px; border-radius: 50%; background: conic-gradient(#e2e8f0 0% 100%); transition: 0.5s; margin-bottom: 10px; }
        .chart-label { font-size: 0.8rem; font-weight: bold; margin-bottom: 10px; }

        .input-group { margin-bottom: 15px; }
        .input-label { font-size: 0.8rem; font-weight: bold; color: #64748b; margin-bottom: 4px; display: block; }
        .dark-mode .input-label { color: #94a3b8; }
        textarea { width: 100%; height: 60px; border: 1px solid var(--border); border-radius: 6px; padding: 10px; box-sizing: border-box; resize: none; font-family: inherit; font-size: 0.9rem; background: var(--card); color: var(--text); }
        .subject-tag { font-size: 0.7rem; font-weight: bold; color: #475569; background: #e2e8f0; padding: 2px 5px; border-radius: 3px; margin-right: 5px; }
        
        .time-input-row { display: flex; align-items: center; gap: 5px; margin-bottom: 8px; font-size: 0.85rem; }
        .time-input-row input { width: 55px; text-align: right; background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 4px; padding: 4px; font-size: 1rem; }
        .save-btn { background: var(--accent); color: white; border: none; padding: 18px; border-radius: 10px; cursor: pointer; width: 100%; margin-top: 15px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .timer-setting { font-size: 0.7rem; color: var(--accent); cursor: pointer; text-decoration: underline; margin-bottom: 5px; }
        #set-info { cursor: pointer; color: var(--accent); text-decoration: dotted underline; }

        /* --- AIç›¸è«‡ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ CSS --- */
        #ai-widget { position: fixed; bottom: 20px; right: 20px; z-index: 1000; font-family: sans-serif; }
        #ai-button { width: 60px; height: 60px; border-radius: 50%; background: #2563eb; color: white; border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 24px; }
        #ai-panel { display: none; position: absolute; bottom: 70px; right: 0; width: 340px; background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); border: 1px solid #e2e8f0; overflow: hidden; flex-direction: column; }
        .dark-mode #ai-panel { background: #1e293b; color: white; border-color: #334155; }
        #ai-header { background: #2563eb; color: white; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; }
        #ai-chat { height: 350px; overflow-y: auto; padding: 10px; font-size: 13px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 85%; line-height: 1.4; white-space: pre-wrap; }
        .msg-user { align-self: flex-end; background: #2563eb; color: white; }
        .msg-ai { align-self: flex-start; background: #f1f5f9; color: #1e293b; border: 1px solid #e2e8f0; }
        .dark-mode .msg-ai { background: #334155; color: white; border-color: #475569; }
        #ai-controls { padding: 10px; border-top: 1px solid #e2e8f0; background: var(--review); display: flex; flex-direction: column; gap: 8px; }
        .dark-mode #ai-controls { border-color: #334155; }
        #ai-mode-select { font-size: 11px; padding: 4px; border-radius: 4px; border: 1px solid #cbd5e1; }
        .ai-input-row { display: flex; gap: 8px; }
        #ai-input { flex: 1; border: 1px solid #e2e8f0; padding: 8px; border-radius: 6px; outline: none; }
        .dark-mode #ai-input { background: #0f172a; border-color: #334155; color: white; }
        .copy-btn { background: #10b981; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-top: 5px; }
    </style>
</head>
<body>

<div class="top-bar">
    <div style="font-weight:bold;">ğŸ“Š ç´¯è¨ˆå­¦ç¿’: <span id="total-lifetime">0.00</span>æ™‚é–“</div>
    <div>
        <button class="backup-btn sync-btn" onclick="generateSyncCode()">ğŸ“¤ åŒæœŸã‚³ãƒ¼ãƒ‰ä½œæˆ</button>
        <button class="backup-btn sync-btn" onclick="loadSyncCode()">ğŸ“¥ ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å¾©å…ƒ</button>
        <button class="backup-btn" onclick="toggleDarkMode()">ğŸŒ“ ãƒ¢ãƒ¼ãƒ‰</button>
        <button class="backup-btn" onclick="exportData()">ğŸ’¾ ä¿å­˜</button>
        <button class="backup-btn" onclick="importData()">ğŸ“‚ å¾©å…ƒ</button>
    </div>
</div>

<div class="container">
    <div>
        <div class="card">
            <div id="timer-mode" style="text-align:center; font-size:0.8rem; font-weight:bold;">é›†ä¸­ã‚¿ã‚¤ãƒ </div>
            <div class="timer-display" id="timer-text">50:00</div>
            <div style="text-align:center;"><span class="timer-setting" onclick="editTimerSettings()">âš™ï¸ ã‚¿ã‚¤ãƒãƒ¼è¨­å®šã‚’å¤‰æ›´</span></div>
            <select id="subject-select" style="width:100%; padding:12px; margin-bottom:15px; border-radius:6px; background:var(--card); color:var(--text); border:1px solid var(--border); font-size:1rem;">
                <option>è²¡å‹™ä¼šè¨ˆè«–(è¨ˆç®—)</option>
                <option>è²¡å‹™ä¼šè¨ˆè«–(ç†è«–)</option>
                <option>ç®¡ç†ä¼šè¨ˆè«–(è¨ˆç®—)</option>
                <option>ç®¡ç†ä¼šè¨ˆè«–(ç†è«–)</option>
                <option>ç›£æŸ»è«–</option>
                <option>ä¼æ¥­æ³•</option>
                <option>ç§Ÿç¨æ³•</option>
                <option>çµŒå–¶å­¦</option>
            </select>
            <div class="btn-group">
                <button id="start-btn" class="btn-main" onclick="startTimer()">å­¦ç¿’ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                <button id="stop-btn" class="btn-main" onclick="stopTimer()" disabled>ã‚¹ãƒˆãƒƒãƒ—</button>
                <button id="cancel-btn" class="btn-main" onclick="cancelTimer()" disabled>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
            <div id="set-info" style="text-align:center; margin-top:12px; font-size:0.9rem; font-weight:bold;" onclick="editSetNum()">ã‚»ãƒƒãƒˆ 1 / 4</div>
        </div>

        <div class="card">
            <div class="chart-box">
                <div class="chart-label">ä»Šæ—¥ã®å†…è¨³</div>
                <div id="pie-today" class="pie-chart"></div>
                <div id="legend-today" style="font-size:0.65rem; width:100%;"></div>
            </div>
            <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">
            <div class="chart-box">
                <div class="chart-label">ç›´è¿‘7æ—¥é–“ã®ç´¯è¨ˆ</div>
                <div id="pie-week" class="pie-chart"></div>
                <div id="legend-week" style="font-size:0.65rem; width:100%;"></div>
            </div>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <button onclick="moveMonth(-1)" class="backup-btn">â—€ å‰æœˆ</button>
            <strong id="calendar-title"></strong>
            <button onclick="moveMonth(1)" class="backup-btn">æ¬¡æœˆ â–¶</button>
        </div>
        <div id="calendar-grid" class="calendar-grid"></div>

        <div id="detail-area" style="margin-top:25px;">
            <div style="font-weight:bold; border-bottom:2px solid var(--accent); padding-bottom:5px; margin-bottom:20px; font-size:1.1rem;" id="selected-date-label"></div>
            <div id="auto-review-area"></div>
            <div class="input-group">
                <span class="input-label" style="color:var(--danger);">ğŸ† å¤§ããªç›®æ¨™ (Ultimate Goal)</span>
                <textarea id="ultimate-goal" placeholder="åˆæ ¼å¾Œã®ãƒ“ã‚¸ãƒ§ãƒ³ã‚„äººç”Ÿã®ç›®æ¨™ãªã©"></textarea>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="input-group">
                    <span class="input-label" style="color:var(--accent);">ğŸ“… ä»Šæœˆã®ç›®æ¨™ (Monthly)</span>
                    <textarea id="monthly-goal" placeholder="ä»Šæœˆæœ«ã¾ã§ã®ãƒãƒ«ãƒ"></textarea>
                </div>
                <div class="input-group">
                    <span class="input-label" style="color:var(--success);">ğŸƒ ä»Šé€±ã®ç›®æ¨™ (Weekly)</span>
                    <textarea id="weekly-goal" placeholder="ä»Šé€±æ—¥æ›œã¾ã§ã®é”æˆé …ç›®"></textarea>
                </div>
            </div>
            <div class="input-group">
                <span class="input-label" style="color:var(--plan);">ğŸ“… æœ¬æ—¥ã®å­¦ç¿’äºˆå®š (Plan)</span>
                <textarea id="plan-input" placeholder="ä»Šæ—¥ã®äºˆå®šã‚’å…¥åŠ›"></textarea>
            </div>
            <hr style="border:0; border-top:1px solid var(--border); margin:25px 0;">
            <div style="font-size:1rem; font-weight:bold; margin-bottom:15px; color:var(--accent);">âœ… ç§‘ç›®åˆ¥ãƒ»é”æˆå†…å®¹ (Done)</div>
            <div id="done-inputs-container"></div>
            <div class="input-group">
                <span class="input-label">ğŸ“ ãã®ä»–ãƒ»æ°—ã¥ããƒ¡ãƒ¢</span>
                <textarea id="done-other" placeholder="ç§‘ç›®ä»¥å¤–ã®æ°—ã¥ãã€åçœãªã©"></textarea>
            </div>
            <div style="font-size:1rem; font-weight:bold; margin-top:25px; margin-bottom:15px;">ğŸ•’ å­¦ç¿’æ™‚é–“ã®ä¿®æ­£</div>
            <div id="time-editor-rows" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px;"></div>
            <button class="save-btn" onclick="saveAll()">ã™ã¹ã¦ã®è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹</button>
        </div>
    </div>
</div>

<div id="ai-widget">
    <div id="ai-panel">
        <div id="ai-header">ğŸ¤– AIå…¨ãƒ‡ãƒ¼ã‚¿è§£æç›¸è«‡ <span style="cursor:pointer" onclick="toggleAI()">Ã—</span></div>
        <div id="ai-chat">
            <div class="msg msg-ai">ã“ã‚Œã¾ã§ã®å­¦ç¿’è¨˜éŒ²ã€å…¨ç›®æ¨™ã€äºˆå®šã€å®Ÿç¸¾ã‚’å…¨ã¦æŠŠæ¡ã§ãã¾ã™ã€‚ç›¸è«‡ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ãã ã•ã„ã€‚</div>
        </div>
        <div id="ai-controls">
            <select id="ai-mode-select">
                <option value="today">ã€ãƒ¢ãƒ¼ãƒ‰ã€‘ä»Šæ—¥ã®å‹‰å¼·ãƒ»è¨ˆç”»ã«ã¤ã„ã¦ç›¸è«‡</option>
                <option value="all">ã€ãƒ¢ãƒ¼ãƒ‰ã€‘å…¨æœŸé–“ã®å­¦ç¿’ã‚’æŒ¯ã‚Šè¿”ã‚Šãƒ»åˆ†æ</option>
            </select>
            <div class="ai-input-row">
                <input type="text" id="ai-input" placeholder="æ‚©ã¿ã‚„è³ªå•ã‚’å…¥åŠ›...">
                <button onclick="askAI()" style="background:#2563eb; color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer">é€ã‚‹</button>
            </div>
        </div>
    </div>
    <button id="ai-button" onclick="toggleAI()">ğŸ’¬</button>
</div>

<script>
    const subjects = ["è²¡å‹™ä¼šè¨ˆè«–(è¨ˆç®—)", "è²¡å‹™ä¼šè¨ˆè«–(ç†è«–)", "ç®¡ç†ä¼šè¨ˆè«–(è¨ˆç®—)", "ç®¡ç†ä¼šè¨ˆè«–(ç†è«–)", "ç›£æŸ»è«–", "ä¼æ¥­æ³•", "ç§Ÿç¨æ³•", "çµŒå–¶å­¦"];
    const colors = ["#ef4444", "#fb923c", "#facc15", "#f59e0b", "#4ade80", "#22d3ee", "#6366f1", "#a855f7"];
    let db = JSON.parse(localStorage.getItem('cpa_v16_db') || '{"days":{},"dark":false,"config":{"work":50,"break":10},"goals":{"ultimate":"","monthly":{},"weekly":{}}}');
    
    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œç”¨å‡¦ç†
    Object.keys(db.days).forEach(date => {
        if (db.days[date].time && db.days[date].time["ç®¡ç†ä¼šè¨ˆè«–"]) {
            db.days[date].time["ç®¡ç†ä¼šè¨ˆè«–(è¨ˆç®—)"] = (db.days[date].time["ç®¡ç†ä¼šè¨ˆè«–(è¨ˆç®—)"] || 0) + db.days[date].time["ç®¡ç†ä¼šè¨ˆè«–"];
            delete db.days[date].time["ç®¡ç†ä¼šè¨ˆè«–"];
        }
        if (db.days[date].done_map && db.days[date].done_map["ç®¡ç†ä¼šè¨ˆè«–"]) {
            db.days[date].done_map["ç®¡ç†ä¼šè¨ˆè«–(è¨ˆç®—)"] = db.days[date].done_map["ç®¡ç†ä¼šè¨ˆè«–"];
            delete db.days[date].done_map["ç®¡ç†ä¼šè¨ˆè«–"];
        }
    });

    if(!db.config) db.config = {work:50, break:10};
    if(!db.goals) db.goals = {ultimate:"", monthly:{}, weekly:{}};

    let timerId = null, isWork = true, setNum = 1;
    let timeLeft = db.config.work * 60;
    let viewDate = new Date();
    const getIso = (d) => d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    let selectedDate = getIso(new Date());

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playBeep(f, d) {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type='sine'; o.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
        o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + d);
    }

    function init() {
        if (db.dark) document.body.classList.add('dark-mode');
        createInputs(); updateLifetime(); renderCalendar(); renderDetail(); updateDisplay();
        checkFirstOfMonth();
    }

    function checkFirstOfMonth() {
        if (new Date().getDate() === 1) setTimeout(() => alert("ğŸ¯ ä»Šæ—¥ã¯1æ—¥ã§ã™ï¼ã€Œä»Šæœˆã®ç›®æ¨™ã€ã‚’è¨­å®šã—ã¾ã—ã‚‡ã†ï¼"), 1000);
    }

    function editTimerSettings() {
        const w = prompt("å‹‰å¼·æ™‚é–“(åˆ†):", db.config.work);
        if (w) {
            const b = prompt("ä¼‘æ†©æ™‚é–“(åˆ†ãƒ»æœ€å¤§20):", db.config.break);
            if (b) {
                db.config.work = Math.max(1, parseInt(w));
                db.config.break = Math.min(20, Math.max(1, parseInt(b)));
                save(false);
                if(!timerId) { timeLeft = db.config.work * 60; isWork = true; updateDisplay(); }
            }
        }
    }

    function editSetNum() {
        const s = prompt("ç¾åœ¨ã®ã‚»ãƒƒãƒˆæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (1-4):", ((setNum-1)%4)+1);
        if (s) {
            const n = parseInt(s);
            if (n >= 1) { setNum = n; updateDisplay(); }
        }
    }

    function generateSyncCode() {
        try {
            const code = btoa(unescape(encodeURIComponent(JSON.stringify(db))));
            navigator.clipboard.writeText(code).then(() => alert("ã‚³ãƒ”ãƒ¼å®Œäº†")).catch(() => prompt("ã‚³ãƒ¼ãƒ‰:", code));
        } catch(e) { alert("å¤±æ•—"); }
    }

    function loadSyncCode() {
        const code = prompt("ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘:");
        if (code) {
            try {
                const decoded = JSON.parse(decodeURIComponent(escape(atob(code))));
                if (confirm("å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) { db = decoded; save(true); location.reload(); }
            } catch(e) { alert("ç„¡åŠ¹"); }
        }
    }

    function createInputs() {
        const doneC = document.getElementById('done-inputs-container'), timeC = document.getElementById('time-editor-rows');
        subjects.forEach(s => {
            doneC.innerHTML += `<div class="input-group"><span class="input-label"><span class="subject-tag">${s}</span></span><textarea class="done-in" data-sub="${s}"></textarea></div>`;
            timeC.innerHTML += `<div class="time-input-row"><div style="font-size:0.7rem; flex:1;">${s}</div><div style="white-space:nowrap;"><input type="number" class="edit-h" data-sub="${s}" min="0">h <input type="number" class="edit-m" data-sub="${s}" min="0">m</div></div>`;
        });
    }

    function drawPie(elementId, legendId, dataMap) {
        const chart = document.getElementById(elementId), legend = document.getElementById(legendId);
        legend.innerHTML = '';
        let total = 0; subjects.forEach(s => total += (dataMap[s] || 0));
        if (total === 0) {
            chart.style.background = `conic-gradient(#e2e8f0 0% 100%)`;
            legend.innerHTML = '<div style="text-align:center; opacity:0.5;">è¨˜éŒ²ãªã—</div>';
        } else {
            let cur = 0;
            const grad = subjects.map((s, i) => {
                const t = dataMap[s] || 0; if (t === 0) return null;
                const end = cur + (t / total) * 100;
                const p = `${colors[i]} ${cur}% ${end}%`; cur = end;
                legend.innerHTML += `<div style="display:inline-block; margin-right:8px;"><span style="color:${colors[i]}">â—</span> ${s.split('(')[0]}: ${(t/3600).toFixed(1)}h</div>`;
                return p;
            }).filter(p => p).join(', ');
            chart.style.background = `conic-gradient(${grad})`;
        }
    }

    function updateCharts() {
        const todayD = (db.days[selectedDate] && db.days[selectedDate].time) || {};
        drawPie('pie-today', 'legend-today', todayD);
        let weekData = {};
        const todayObj = new Date(selectedDate);
        for (let i = 0; i < 7; i++) {
            const date = new Date(todayObj); date.setDate(date.getDate() - i);
            const iso = getIso(date), dayData = (db.days[iso] && db.days[iso].time) || {};
            subjects.forEach(s => weekData[s] = (weekData[s] || 0) + (dayData[s] || 0));
        }
        drawPie('pie-week', 'legend-week', weekData);
    }

    function startTimer() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        if (timerId) return;
        timerId = setInterval(() => {
            timeLeft--;
            if (isWork) {
                if (!db.days[selectedDate]) db.days[selectedDate] = { time: {}, plan: "", done_map: {}, done_other: "" };
                const sub = document.getElementById('subject-select').value;
                if(!db.days[selectedDate].time) db.days[selectedDate].time = {};
                db.days[selectedDate].time[sub] = (db.days[selectedDate].time[sub] || 0) + 1;
                if (timeLeft % 10 === 0) save(false);
            }
            if (timeLeft <= 0) {
                if (isWork) {
                    playBeep(880, 0.6); isWork = false;
                    timeLeft = db.config.break * 60;
                    save(true); renderDetail();
                } else {
                    playBeep(523, 0.6); isWork = true;
                    timeLeft = db.config.work * 60;
                    setNum++;
                }
            }
            updateDisplay();
        }, 1000);
        toggleButtons(true);
    }

    function stopTimer() { clearInterval(timerId); timerId = null; toggleButtons(false); save(true); renderDetail(); }
    function cancelTimer() { if (confirm("ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) { clearInterval(timerId); timerId = null; isWork = true; timeLeft = db.config.work * 60; updateDisplay(); toggleButtons(false); } }
    function toggleButtons(r) { document.getElementById('start-btn').disabled = r; document.getElementById('stop-btn').disabled = !r; document.getElementById('cancel-btn').disabled = !r; }
    
    function updateDisplay() {
        const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
        document.getElementById('timer-text').textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        const modeEl = document.getElementById('timer-mode');
        modeEl.textContent = isWork ? "é›†ä¸­ã‚¿ã‚¤ãƒ " : "ä¼‘æ†©ä¸­";
        modeEl.style.color = isWork ? "" : "var(--success)";
        document.getElementById('set-info').textContent = `ã‚»ãƒƒãƒˆ ${((setNum-1)%4)+1} / 4`;
    }

    function renderCalendar() {
        const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
        const year = viewDate.getFullYear(), month = viewDate.getMonth();
        document.getElementById('calendar-title').textContent = `${year}å¹´ ${month + 1}æœˆ`;
        ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(h => grid.innerHTML += `<div class="cal-header">${h}</div>`);
        const first = new Date(year, month, 1).getDay(), last = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < first; i++) grid.innerHTML += '<div></div>';
        for (let d = 1; d <= last; d++) {
            const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const data = db.days[ds] || { time: {} };
            let t = 0; if(data.time) Object.values(data.time).forEach(v => t += v);
            const div = document.createElement('div');
            div.className = `cal-day ${ds === selectedDate ? 'active' : ''}`;
            div.innerHTML = `<div>${d}</div><div style="font-size:0.55rem; opacity:0.7;">${(t/3600).toFixed(1)}h</div>
                <div class="marker-container">${t > 0 ? '<span class="dot" style="color:var(--success)">â—</span>' : ''}${data.plan ? '<span class="dot" style="color:var(--plan)">ğŸ“…</span>' : ''}</div>`;
            div.onclick = () => { selectedDate = ds; renderCalendar(); renderDetail(); };
            grid.appendChild(div);
        }
    }

    function renderDetail() {
        const d = db.days[selectedDate] || { time: {}, plan: "", done_map: {}, done_other: "" };
        const selDateObj = new Date(selectedDate), monKey = `${selDateObj.getFullYear()}-${selDateObj.getMonth()+1}`;
        const tempDate = new Date(selDateObj), day = tempDate.getDay(), diff = tempDate.getDate() - day + (day === 0 ? -6 : 1);
        const weekKey = getIso(new Date(tempDate.setDate(diff)));
        document.getElementById('selected-date-label').textContent = `${selectedDate} ã®è¨˜éŒ²`;
        document.getElementById('plan-input').value = d.plan || "";
        document.getElementById('ultimate-goal').value = db.goals.ultimate || "";
        document.getElementById('monthly-goal').value = db.goals.monthly[monKey] || "";
        document.getElementById('weekly-goal').value = db.goals.weekly[weekKey] || "";
        document.getElementById('done-other').value = d.done_other || "";
        document.querySelectorAll('.done-in').forEach(t => t.value = (d.done_map && d.done_map[t.dataset.sub]) ? d.done_map[t.dataset.sub] : "");
        document.querySelectorAll('.edit-h').forEach(i => {
            const sec = (d.time && d.time[i.dataset.sub]) || 0;
            i.value = Math.floor(sec / 3600); i.nextElementSibling.value = Math.floor((sec % 3600) / 60);
        });
        updateCharts();
        const rev = document.getElementById('auto-review-area'); rev.innerHTML = '';
        [{d:1,l:"1æ—¥å‰"},{d:3,l:"3æ—¥å‰"},{d:7,l:"1é€±å‰"},{d:28,l:"4é€±å‰"}].forEach(inv => {
            const past = getIso(new Date(new Date(selectedDate).setDate(new Date(selectedDate).getDate() - inv.d)));
            const p = db.days[past];
            if (p && p.done_map) {
                let h = ""; for (let s in p.done_map) if (p.done_map[s]) h += `<div><span class="subject-tag">${s}</span> ${p.done_map[s]}</div>`;
                if (h) rev.innerHTML += `<div class="card" style="padding:12px; font-size:0.8rem; border-left:4px solid var(--accent); margin-bottom:12px; background:var(--review);"><b>ğŸ§  ${inv.l}ã®å¾©ç¿’:</b>${h}</div>`;
            }
        });
    }

    window.saveAll = () => {
        if (!db.days[selectedDate]) db.days[selectedDate] = { time: {}, plan: "", done_map: {}, done_other: "" };
        const d = db.days[selectedDate], selDateObj = new Date(selectedDate), monKey = `${selDateObj.getFullYear()}-${selDateObj.getMonth()+1}`;
        const tempDate = new Date(selDateObj), day = tempDate.getDay(), diff = tempDate.getDate() - day + (day === 0 ? -6 : 1), weekKey = getIso(new Date(tempDate.setDate(diff)));
        db.goals.ultimate = document.getElementById('ultimate-goal').value;
        db.goals.monthly[monKey] = document.getElementById('monthly-goal').value;
        db.goals.weekly[weekKey] = document.getElementById('weekly-goal').value;
        d.plan = document.getElementById('plan-input').value; d.done_other = document.getElementById('done-other').value;
        d.done_map = {}; document.querySelectorAll('.done-in').forEach(t => d.done_map[t.dataset.sub] = t.value);
        if(!d.time) d.time = {};
        document.querySelectorAll('.edit-h').forEach(i => {
            const h = parseInt(i.value || 0), m = parseInt(i.nextElementSibling.value || 0);
            d.time[i.dataset.sub] = (h * 3600) + (m * 60);
        });
        save(true); renderDetail(); alert("ä¿å­˜å®Œäº†");
    };

    function toggleDarkMode() { db.dark = !db.dark; document.body.classList.toggle('dark-mode'); save(false); }
    function save(ref) { localStorage.setItem('cpa_v16_db', JSON.stringify(db)); updateLifetime(); if(ref) renderCalendar(); }
    function updateLifetime() { let t = 0; Object.values(db.days).forEach(d => { if(d.time) Object.values(d.time).forEach(v => t += v); }); document.getElementById('total-lifetime').textContent = (t/3600).toFixed(2); }
    function exportData() { const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([JSON.stringify(db)], {type: "application/json"})); a.download = `cpa_v21_backup.json`; a.click(); }
    function importData() { const i = document.createElement('input'); i.type = 'file'; i.onchange = e => { const r = new FileReader(); r.readAsText(e.target.files[0]); r.onload = x => { db = JSON.parse(x.target.result); save(true); location.reload(); }; }; i.click(); }
    window.moveMonth = (n) => { viewDate.setMonth(viewDate.getMonth() + n); renderCalendar(); };

    /* --- AIå…¨è§£æ & ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ --- */
    function toggleAI() {
        const p = document.getElementById('ai-panel');
        p.style.display = (p.style.display === 'flex') ? 'none' : 'flex';
    }

    function askAI() {
        const input = document.getElementById('ai-input');
        const mode = document.getElementById('ai-mode-select').value;
        const chat = document.getElementById('ai-chat');
        if(!input.value) return;

        const userText = input.value;
        
        // 1. å…¨å­¦ç¿’å±¥æ­´ï¼ˆãƒ†ã‚­ã‚¹ãƒˆå«ã‚€ï¼‰ã‚’æŠ½å‡º
        let historySummary = "";
        Object.keys(db.days).sort().forEach(date => {
            const day = db.days[date];
            let dailyTotal = 0;
            if(day.time) Object.values(day.time).forEach(s => dailyTotal += s);
            // è¨˜éŒ²ãŒã‚ã‚‹æ—¥ã ã‘æŠ½å‡º
            if(dailyTotal > 0 || day.plan || day.done_other) {
                historySummary += `--- ${date} ---\n`;
                historySummary += `æ™‚é–“: ${(dailyTotal/3600).toFixed(1)}h\n`;
                if(day.plan) historySummary += `äºˆå®š: ${day.plan}\n`;
                if(day.done_map) {
                    let dStr = "";
                    for(let s in day.done_map) if(day.done_map[s]) dStr += `[${s}: ${day.done_map[s]}] `;
                    if(dStr) historySummary += `å®Ÿç¸¾: ${dStr}\n`;
                }
                if(day.done_other) historySummary += `ãƒ¡ãƒ¢: ${day.done_other}\n`;
            }
        });

        // 2. ç›®æ¨™è¨­å®šã‚’æŠ½å‡º
        const currentMonKey = `${new Date().getFullYear()}-${new Date().getMonth()+1}`;
        const goalsContext = `ã€ç©¶æ¥µç›®æ¨™ã€‘: ${db.goals.ultimate || "æœªè¨­å®š"}\nã€ä»Šæœˆã®ç›®æ¨™ã€‘: ${db.goals.monthly[currentMonKey] || "æœªè¨­å®š"}`;

        // 3. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆçµ„ã¿ç«‹ã¦
        let fullContext = "";
        if(mode === "today") {
            fullContext = `å…¬èªä¼šè¨ˆå£«å—é¨“ç”Ÿã§ã™ã€‚ä»Šæ—¥ã®å­¦ç¿’è¨ˆç”»ã«ã¤ã„ã¦ç›¸è«‡ã§ã™ã€‚\n\n${goalsContext}\n\nã€ä»Šæ—¥ã®äºˆå®šã€‘: ${document.getElementById('plan-input').value}\nã€ä»Šæ—¥ã®ã“ã‚Œã¾ã§ã®å®Ÿç¸¾ã€‘: ${JSON.stringify(db.days[selectedDate]?.done_map || {})}\n\nã€è³ªå•ã€‘: ${userText}`;
        } else {
            fullContext = `å…¬èªä¼šè¨ˆå£«å—é¨“ç”Ÿã§ã™ã€‚ã“ã‚Œã¾ã§ã®å…¨å­¦ç¿’è¨˜éŒ²ã«åŸºã¥ãã€å‚¾å‘åˆ†æã‚„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚\n\n${goalsContext}\n\nã€å­¦ç¿’å±¥æ­´ä¸€è¦§ã€‘\n${historySummary}\n\nã€ç›¸è«‡å†…å®¹ã€‘: ${userText}`;
        }

        // è¡¨ç¤ºç”¨
        const uMsg = document.createElement('div');
        uMsg.className = 'msg msg-user';
        uMsg.textContent = userText;
        chat.appendChild(uMsg);

        setTimeout(() => {
            const aMsg = document.createElement('div');
            aMsg.className = 'msg msg-ai';
            const copyId = "copy-text-" + Date.now();
            aMsg.innerHTML = `
                <strong>å…¨ãƒ‡ãƒ¼ã‚¿ã‚’è§£æç”¨ã«æ•´ç†ã—ã¾ã—ãŸã€‚</strong><br>
                ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚³ãƒ”ãƒ¼ã—ã€Geminiã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br>
                <textarea id="${copyId}" style="position:absolute; left:-9999px;">${fullContext}</textarea>
                <button class="copy-btn" onclick="copyToClip('${copyId}')">ğŸ“‹ ç›¸è«‡å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹</button>
            `;
            chat.appendChild(aMsg);
            chat.scrollTop = chat.scrollHeight;
        }, 600);

        input.value = '';
        chat.scrollTop = chat.scrollHeight;
    }

    function copyToClip(id) {
        const textArea = document.getElementById(id);
        textArea.select();
        document.execCommand('copy');
        alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ãã®ã¾ã¾Geminiã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
    }

    init();
</script>
</body>
</html>
